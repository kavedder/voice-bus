<?xml version="1.0" encoding="UTF-8"?>
<vxml version = "2.1" application="root.xml">
  <meta name="maintainer" content="kvedder@uw.edu"/>

  <link next="#MainMenu">
    <!-- The XML grammar for the main menu. -->
    <grammar src="main_menu.grxml" type="application/grammar-xml"/>
  </link>

  <link next="#Help">
    <!-- The XML grammar for the help menu. -->
    <grammar src="help.grxml" type="application/grammar-xml"/>
  </link>

  <!-- Each module is in its own form, so that we can easily use
       gotos to navigate around. This is not a super clean vanilla
       call flow, but gives us more control.
  -->

  <!-- BEGIN MAIN -->
  <form id="MainMenu">
    <block>
      <prompt bargein="true">
        <!-- Welcome to the interactive bus information hotline, powered by Puget Sound Transit and One Bus Away. -->
        Hi.
      </prompt>
      <goto next="#StopNo" />
    </block>
  </form>

  <!-- BEGIN GET STOP NUMBER -->
  <form id="StopNo">
    <field name="stopno">
      <grammar src="stopno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say your stop number.
      </prompt>

      <noinput>
        I did not hear anything. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </nomatch>

      <filled namelist="stopno$.interpretation">

        <script src="convertNumber.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="getUrls.js" fetchhint="prefetch" fetchtimeout="10s" />
        <!-- for some reason this wouldn't work in a separate file :-( TODO: fix that -->
        <script>
          <![CDATA[
                   function getStatus(doc) {
                   var response = doc.getElementsByTagName("text").item(0).firstChild.data;
                   if ( response == "OK" ) {
                   return "true"; }
                   return "false";
                   }
          ]]>
        </script>
        
        <assign name="application.externalStopNo" expr="stopno$.interpretation" />
        <assign name="application.internalStopNo" expr="convertNumber(externalStopNo)" />
        <assign name="application.URL" expr="getStopUrl(internalStopNo)" />

        <data name="doc" srcexpr="URL" />
        <assign name="application.xml_data" expr="doc.documentElement" />
        <assign name="application.isValidUrl" expr="getStatus(xml_data)" />
        
        <if cond="isValidUrl=='true'">
          <goto next="main.xml#VerifyStopNo" />
          <else />
          <prompt>
            I'm sorry, <value expr="application.externalStopNo" /> does not seem to be a valid bus stop. Please try again.
          </prompt>
          <goto next="main.xml#StopNo" />
        </if>
      </filled>
    </field>
  </form>
  <!-- END GET STOP NUMBER -->

  <!-- BEGIN VERIFY STOP NUMBER -->
  <form id="VerifyStopNo">
    <field name="verifystopno">
      <grammar src="yes_or_no.grxml" type="application/grammar-xml"/>
      <prompt>
        I heard <value expr="application.externalStopNo" />. Is that correct?
      </prompt>
      
      <noinput>
        Sorry, I didn't quite catch that.
        <reprompt/>
      </noinput>
      
      <nomatch>
        Sorry, I didn't quite catch that.
        <reprompt/>
      </nomatch>
      
      <filled namelist="verifystopno">
        <prompt> <value expr="verifystopno$.utterance" /> </prompt>
        <if cond="response=='no'">
          <prompt> I'm sorry! Let's try again </prompt>
          <goto next="main.xml#StopNo" />
          <else />
          <prompt> Okay! </prompt>
          <goto next="main.xml#BusNo" />
        </if>
      </filled>
    </field>
  </form>

  <!-- END VERIFY STOP NUMBER -->

  <!-- BEGIN GET BUS NUMBER -->
  <form id="BusNo">
    <field name="busno">
      <grammar src="busno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say your bus number.
      </prompt>

      <noinput>
        I did not hear anything. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. Please try again.
        <reprompt/>
      </nomatch>


      <filled namelist="busno$.interpretation">

        <var name="busno" />
        <assign name="application.externalBusNo" expr="busno$.interpretation" />
        <script src="convertNumber.js" fetchhint="prefetch" fetchtimeout="10s" />
        <assign name="application.internalBusNo" expr="convertNumber(application.externalBusNo)" />

        <prompt>
          The bus number you have selected is <value expr="application.internalBusNo" />.
          <break strength="medium"/>
        </prompt>
      </filled>
    </field>
    <!-- END GET BUS NUMBER -->

  </form>
  <!-- END MAIN -->


  <form id="Help">
    <block>
      <prompt bargein="false">
        This is a speech enabled bus information service. You will be guided through the steps of setting your location
        and desired routes. Let's start at the beginning.
      </prompt>
      <goto next="#MainMenu" />
    </block>
  </form>

</vxml>
