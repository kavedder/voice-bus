<?xml version="1.0" encoding="UTF-8"?>
<vxml version = "2.1">
  <meta name="maintainer" content="kvedder@uw.edu"/>
  <var name="internalStopNo" />
  <var name="externalStopNo" />
  <var name="internalBusNo" />
  <var name="externalBusNo" />
  <var name="URL" />
  <var name="xml_data" />

  <link next="#MainMenu">
    <!-- The XML grammar for the main menu. -->
    <grammar src="main_menu.grxml" type="application/grammar-xml"/>
  </link>

  <link next="#Help">
    <!-- The XML grammar for the help menu. -->
    <grammar src="help.grxml" type="application/grammar-xml"/>
  </link>


  <!-- BEGIN MAIN -->
  <form id="MainMenu">
    <block>
      <prompt bargein="true">
        <!-- Welcome to the interactive bus information hotline, powered by Puget Sound Transit and One Bus Away. -->
        Hi.
      </prompt>
    </block>

    <!-- BEGIN GET STOP NUMBER -->
    <field name="stopno">
      <grammar src="stopno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say your stop number.
      </prompt>

      <noinput>
        I did not hear anything. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </nomatch>


      <filled namelist="stopno.interpretation">

        <script src="convertNumber.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="getUrls.js" fetchhint="prefetch" fetchtimeout="10s" />
        <!--<script src="fetchUrlData.js" fetchhint="prefetch" fetchtimeout="10s" />-->
        <assign name="application.externalStopNo" expr="stopno$.interpretation" />
        <assign name="application.internalStopNo" expr="convertNumber(application.externalStopNo)" />
        <assign name="application.URL" expr="getStopUrl(application.internalStopNo)" />

        <data name="doc" srcexpr="application.URL" />
        <assign name="application.xml_data" expr="doc.documentElement" />

        <!-- for some reason this wouldn't work in a separate file :-( TODO: fix that -->
        <script>
          <![CDATA[
                   function getStatus(doc) {
                   response = doc.getElementsByTagName("text").item(0).firstChild.data;
                   if ( response == "OK" ) {
                   return "true";
                   }
                   return "false";
                   }
          ]]>
        </script>
        <prompt>
          <value expr="getStatus(application.xml_data)" />
          <break strength="medium"/>
        </prompt>
      </filled>
    </field>
    <!-- END GET STOP NUMBER -->

    <!-- BEGIN GET BUS NUMBER -->
    <field name="busno">
      <grammar src="busno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say your bus number.
      </prompt>

      <noinput>
        I did not hear anything. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. Please try again.
        <reprompt/>
      </nomatch>


      <filled namelist="busno.interpretation">

        <var name="busno" />
        <assign name="busno" expr="busno$.interpretation" />
        <script src="convertNumber.js" fetchhint="prefetch" fetchtimeout="10s" />

        <prompt>
          The bus number you have selected is <value expr="busno" />.
          Converted, that is <value expr="convertNumber(busno)" />
          <break strength="medium"/>
        </prompt>
      </filled>
    </field>
    <!-- END GET BUS NUMBER -->

  </form>
  <!-- END MAIN -->


  <form id="Help">
    <block>
      <prompt bargein="false">
        This is a speech enabled bus information service. You will be guided through the steps of setting your location
        and desired routes. Let's start at the beginning.
      </prompt>
      <goto next="#MainMenu" />
    </block>
  </form>

</vxml>
