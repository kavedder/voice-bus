<?xml version="1.0" encoding="UTF-8"?>
<vxml version = "2.1" application="root.xml">
  <meta name="maintainer" content="kvedder@uw.edu"/>

  <link next="#MainMenu">
    <!-- The XML grammar for the main menu. -->
    <grammar src="main_menu.grxml" type="application/grammar-xml"/>
  </link>

  <link next="#Help">
    <!-- The XML grammar for the help menu. -->
    <grammar src="help.grxml" type="application/grammar-xml"/>
  </link>

  <!-- Each module is in its own form, so that we can easily use
       gotos to navigate around. This is not a super clean vanilla
       call flow, but gives us more control.
  -->

  <!-- BEGIN MAIN -->
  <form id="MainMenu">
    <block>
      <prompt bargein="true">
        <!-- TODO: uncomment -->
        <!-- Welcome to the interactive bus information hotline, powered by Puget Sound Transit and One Bus Away. -->
        Hi.
      </prompt>
      <goto next="#StopNo" />
    </block>
  </form>

  <!-- BEGIN GET STOP NUMBER -->
  <form id="StopNo">
    <field name="stopno">
      <grammar src="stopno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say your stop number.
      </prompt>

      <noinput>
        I did not hear anything. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. The stop numbers are shown on the bus stop flag, or on the timetable mounted near the stop. Please try again.
        <reprompt/>
      </nomatch>

      <filled namelist="stopno$.interpretation">

        <script src="convertBus.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="getStopUrl.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="getArrivalUrl.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="fetchUrlData.js" fetchhint="prefetch" fetchtimeout="10s" />

        <assign name="application.spokenStopNo" expr="stopno$.interpretation" />
        <assign name="application.writtenStopNo" expr="convertBus(application.spokenStopNo,'foo')" />
        <assign name="application.stopUrl" expr="getStopUrl(application.writtenStopNo)" />
        <assign name="application.arrivalUrl" expr="getArrivalUrl(application.writtenStopNo)" />


        <data name="doc" srcexpr="stopUrl" />
        <assign name="application.xmlData" expr="doc.documentElement" />
        <assign name="application.isValidUrl" expr="getStatus(application.xmlData)" />

        <if cond="isValidUrl=='true'">
          <assign name="application.stopLoc" expr="getStopLoc(application.xmlData)" />
          <goto next="main.xml#VerifyStopNo" />

          <else />
          <prompt>
            I'm sorry, <value expr="application.spokenStopNo" /> does not seem to be a valid bus stop. Please try again.
          </prompt>
          <goto next="main.xml#StopNo" />
        </if>
      </filled>
    </field>
  </form>
  <!-- END GET STOP NUMBER -->

  <!-- BEGIN VERIFY STOP NUMBER -->
  <form id="VerifyStopNo">
    <field name="verifystopno">
      <grammar src="yes_or_no.grxml" type="application/grammar-xml"/>
      <prompt>
        I heard <value expr="application.spokenStopNo" />,
        which is <value expr="application.stopLoc" />.
        Is that correct?
      </prompt>

      <noinput>
        Sorry, I didn't quite catch that.
        <reprompt/>
      </noinput>

      <nomatch>
        Sorry, I didn't quite catch that.
        <reprompt/>
      </nomatch>

      <filled namelist="verifystopno">
        <var name="response" expr="verifystopno$.utterance.response" />
        <if cond="response=='no'">
          <prompt> I'm sorry! Let's try again </prompt>
          <goto next="main.xml#StopNo" />
          <else />
          <prompt> Okay! </prompt>
          <script src="getUrls.js" fetchhint="prefetch" fetchtimeout="10s" />
          <goto next="main.xml#BusNo" />
        </if>
      </filled>
    </field>
  </form>

  <!-- END VERIFY STOP NUMBER -->

  <!-- BEGIN GET BUS NUMBER -->
  <form id="BusNo">
    <field name="busno">
      <grammar src="busno.grxml" type="application/grammar-xml"/>
      <prompt>
        Please say the bus number you are looking for, or say all buses.
      </prompt>

      <noinput>
        I did not hear anything. Please try again.
        <reprompt/>
      </noinput>

      <nomatch>
        I did not recognize what you said. Please try again.
        <reprompt/>
      </nomatch>


      <filled namelist="busno$.interpretation">
        <assign name="application.busType" expr="busno$.interpretation.bus_type" />
        <assign name="application.spokenBusNo" expr="busno$.utterance" />
        <script src="convertBus.js" fetchhint="prefetch" fetchtimeout="10s" />
        <script src="getRoutes.js" fetchhint="prefetch" fetchtimeout="10s" />
        <assign name="application.writtenBusNo" expr="convertBus(application.spokenBusNo, application.busType)" />

        <data name="doc" srcexpr="application.arrivalUrl" />
        <assign name="application.arrivalXmlData" expr="doc.documentElement" />
        <assign name="routelist" expr="getRoutes(application.arrivalXmlData, application.writtenBusNo, application.spokenBusNo)" />

        <if cond="application.busType=='number'">
          <prompt>
            <value expr="routelist" />
          </prompt>
          <elseif cond="application.busType=='letter'" />
          <prompt>
            <value expr="routelist" />
          </prompt>
          <else />
          <prompt>
            Fetching all buses, yo.
          </prompt>
        </if>
      </filled>
    </field>
    <!-- END GET BUS NUMBER -->

  </form>
  <!-- END MAIN -->


  <form id="Help">
    <block>
      <prompt bargein="false">
        This is a speech enabled bus information service. You will be guided through the steps of setting your location
        and desired routes. Let's start at the beginning.
      </prompt>
      <goto next="#MainMenu" />
    </block>
  </form>

</vxml>
